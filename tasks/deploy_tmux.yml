- name: Deploy TMUX
  block:
    - name: Install TMUX
      ansible.builtin.package:
        name: tmux
        state: present
      become: true

    - name: Ensure TMUX config directory exists
      ansible.builtin.file:
        path: /home/michel/.config/tmux
        state: directory
        owner: michel
        mode: '0755'
      become: true

    - name: Copy TMUX config file
      ansible.builtin.copy:
        src: files/tmux.conf
        dest: /home/michel/.config/tmux/tmux.conf
        owner: michel
        mode: '0644'
      become: true

    - name: Ensure TMUX plugin manager directory exists
      ansible.builtin.file:
        path: /home/michel/.config/tmux/plugins
        state: directory
        owner: michel
        mode: '0755'
      become: true

    - name: Clone TMUX plugin manager repository
      ansible.builtin.git:
        repo: https://github.com/tmux-plugins/tpm.git
        dest: /home/michel/.config/tmux/plugins/tpm
        version: master
        update: yes
      become: true

    - name: Install Tmux plugins
      ansible.builtin.shell: |
        tmux start-server
        tmux new-session -d
        sleep 1 # Give tmux a moment to start
        tmux send-keys -t 0 "run '/home/michel/.config/tmux/plugins/tpm/tpm'" C-m
        tmux send-keys -t 0 "prefix + I" # Simulate pressing prefix + I
        tmux kill-session -t 0
      args:
        executable: /bin/bash
      changed_when: false # This command always indicates a change for simplicity

  rescue:
  - name: Handle failure
    ansible.builtin.debug:
      msg: "An error occurred during TMUX deployment."
  - name: Increment failure counter
    ansible.builtin.set_fact:
      failure_counter: "{{ failure_counter | default(0) | int + 1 }}"